<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" data-content_root="../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kubernetes Device Plugin 使用手册 &mdash; moffettdoc v1.0 文档</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/my_theme.css?v=5b4135ee" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/highlight.css?v=af260240" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=5a3fd9cb"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../../_static/translations.js?v=beaddf03"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../search.html" />
    <link rel="prev" title="SOLA容器化示例" href="SOLA-docker.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            moffettdoc
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" aria-label="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <p class="caption" role="heading"><span class="caption-text">墨芯产品文档</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">MACS系统用户手册</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../overview.html">MACS 产品手册</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release_notes.html">发布日志</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation/index.html">安装指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tool/index.html">工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sola-demo/index.html">SOLA示例验证手册</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Moffett 云原生</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="SOLA-docker.html">SOLA容器化示例</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Kubernetes Device Plugin 使用手册</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">简介</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">注意事项</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">版本兼容</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">如何部署</a></li>
<li class="toctree-l4"><a class="reference internal" href="#k8sai">如何在k8s中使用墨芯AI加速卡</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">moffettdoc</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">MACS系统用户手册</a></li>
          <li class="breadcrumb-item"><a href="index.html">Moffett 云原生</a></li>
      <li class="breadcrumb-item active">Kubernetes Device Plugin 使用手册</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/docs/macs-1.1/AI-Native/k8s-device-plugin.md.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="kubernetes-device-plugin">
<h1>Kubernetes Device Plugin 使用手册<a class="headerlink" href="#kubernetes-device-plugin" title="Link to this heading"></a></h1>
<section id="id1">
<h2>简介<a class="headerlink" href="#id1" title="Link to this heading"></a></h2>
<p>MOFFETT Kubernetes Device Plugin 是运行在 Kubernetes 上的 DaemonSet，并自动提供以下支持：</p>
<ul class="simple">
<li><p>向 Kubernetes 暴露集群中每个节点上的墨芯 AI 加速卡设备数量。</p></li>
<li><p>持续监控墨芯 AI 加速卡设备的健康状况。</p></li>
<li><p>在 Kubernetes 集群中运行使用墨芯 AI 加速卡的容器。</p></li>
</ul>
</section>
<section id="id2">
<h2>注意事项<a class="headerlink" href="#id2" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>使用 v1beta1 版本的 Kubernetes device plugin API，支持 Kubernetes 1.10 以上的版本</p></li>
<li><p>plugin 目前需要以特权模式运行</p></li>
<li><p>对墨芯 AI 加速卡的修改操作，如reboot等，之后都应该重启plugin</p></li>
</ul>
</section>
<section id="id3">
<h2>版本兼容<a class="headerlink" href="#id3" title="Link to this heading"></a></h2>
<p>| plugin | SOLA ToolKit |
| :—-: | :———-: |
| v0.1.0 |   &gt;= 3.5.0   |</p>
</section>
<section id="id4">
<h2>如何部署<a class="headerlink" href="#id4" title="Link to this heading"></a></h2>
<section id="id5">
<h3>准备<a class="headerlink" href="#id5" title="Link to this heading"></a></h3>
<ol>
<li><p>安装好 SOLA ToolKit 的宿主机（需注意 <a class="reference external" href="#%E7%89%88%E6%9C%AC%E5%85%BC%E5%AE%B9">plugin 和 SOLA 的兼容关系</a>）</p></li>
<li><p>Kubernetes version &gt;= 1.10</p></li>
<li><p>获取 plugin 镜像:</p>
<ul class="simple">
<li><p>在线版本：</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>docker<span class="w"> </span>pull<span class="w"> </span>moffett/k8s-device-plugin:v0.1.0
docker<span class="w"> </span>images<span class="w"> </span><span class="p">|</span>grep<span class="w"> </span>k8s-device-plugin
</pre></div>
</div>
<ul class="simple">
<li><p>离线版本：</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>wget<span class="w"> </span>https://moffett-oss-bucket01.oss-cn-shenzhen.aliyuncs.com/CloudNative/moffett-k8s-device-plugin-v0.1.0.tar
docker<span class="w"> </span>load<span class="w"> </span>-i<span class="w"> </span>moffett-k8s-device-plugin-v0.1.0.tar
docker<span class="w"> </span>images<span class="w"> </span><span class="p">|</span>grep<span class="w"> </span>k8s-device-plugin
</pre></div>
</div>
</li>
</ol>
</section>
<section id="id6">
<h3>部署<a class="headerlink" href="#id6" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>moffett-device-plugin.yml 示例</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DaemonSet</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">moffett-device-plugin-daemonset</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">moffett-device-plugin-ds</span>
<span class="w">  </span><span class="nt">updateStrategy</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RollingUpdate</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">moffett-device-plugin-ds</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">tolerations</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">moffett.ai/spu</span>
<span class="w">        </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Exists</span>
<span class="w">        </span><span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NoSchedule</span>
<span class="w">      </span><span class="c1"># Mark this pod as a critical add-on; when enabled, the critical add-on</span>
<span class="w">      </span><span class="c1"># scheduler reserves resources for critical add-on pods so that they can</span>
<span class="w">      </span><span class="c1"># be rescheduled after a failure.</span>
<span class="w">      </span><span class="c1"># See https://kubernetes.io/docs/tasks/administer-cluster/guaranteed-scheduling-critical-addon-pods/</span>
<span class="w">      </span><span class="nt">priorityClassName</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;system-node-critical&quot;</span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">moffett/k8s-device-plugin:v0.1.0</span>
<span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">moffett-device-plugin-ctr</span>
<span class="w">        </span><span class="nt">securityContext</span><span class="p">:</span>
<span class="w">          </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">device-plugin</span>
<span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/lib/kubelet/device-plugins</span>
<span class="w">      </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">device-plugin</span>
<span class="w">        </span><span class="nt">hostPath</span><span class="p">:</span>
<span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/lib/kubelet/device-plugins</span>
</pre></div>
</div>
<ul class="simple">
<li><p>使用yaml，在k8s中启动plugin</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>create<span class="w"> </span>-f<span class="w"> </span>moffett-device-plugin.yml
</pre></div>
</div>
</section>
</section>
<section id="k8sai">
<h2>如何在k8s中使用墨芯AI加速卡<a class="headerlink" href="#k8sai" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>获取 SOLA 基础镜像</p></li>
<li><p>在k8s中启动镜像，下面是请求墨芯 AI 加速卡设备资源(<code class="docutils literal notranslate"><span class="pre">moffett.ai/spu</span></code>)的Pod示例，假设我们运行的镜像为 <code class="docutils literal notranslate"><span class="pre">sola:3.5.0</span></code></p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">spu-pod</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Never</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sola-container</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sola:3.5.0</span>
<span class="w">    </span><span class="nt">securityContext</span><span class="p">:</span>
<span class="w">      </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">      </span><span class="nt">limits</span><span class="p">:</span>
<span class="w">        </span><span class="nt">moffett.ai/spu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="w">  </span><span class="nt">tolerations</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">moffett.ai/spu</span>
<span class="w">    </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Exists</span>
<span class="w">    </span><span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NoSchedule</span>
<span class="c1">#</span>
<span class="c1"># 这个 pod 需要两个 moffett.ai/spu 设备</span>
<span class="c1"># 而且只能够调度到满足需求的节点上</span>
<span class="c1">#</span>
<span class="c1"># 如果该节点中有 2 个以上的设备可用，其余的可供其他 Pod 使用</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="页脚">
        <a href="SOLA-docker.html" class="btn btn-neutral float-left" title="SOLA容器化示例" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2024, zhaoyang.li。</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>